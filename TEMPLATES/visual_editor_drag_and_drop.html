<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Editor Visuale Drag & Drop: {{ project_name }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        body > main { padding: 1rem; }
        .container { max-width: 1200px; margin: auto; }
        nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .editor-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 2rem; align-items: start; }
        .list-item, .item-row { display: grid; gap: 1rem; align-items: center; margin-bottom: 1rem; }
        .list-item { grid-template-columns: 1fr auto; }
        .item-row { grid-template-columns: 1fr 1fr auto; }
        .list-item input, .item-row input, .item-row select { margin-bottom: 0; }
        .remove-btn { background-color: var(--secondary); border-color: var(--secondary); color: var(--secondary-inverse); padding: 0.5rem 0.75rem; }
    </style>
</head>
<body>
    <main class="container">
        <nav>
            <div>
                <a href="{{ url_for('dashboard') }}">‚Üê Dashboard</a>
                <a href="{{ url_for('edit_project', project_name=project_name) }}" style="margin-left: 1rem;">Editor Codice</a>
            </div>
            <button id="save-all-btn">Salva Tutte le Modifiche</button>
        </nav>

        <h1>Editor Visuale per <em>{{ project_name }}</em></h1>
        <p>Gestisci le categorie e gli elementi da trascinare.</p>

        <div class="editor-grid">
            <article>
                <header><strong>Categorie</strong></header>
                <div id="categories-container"></div>
                <button id="add-category-btn" class="outline">Aggiungi Categoria</button>
            </article>

            <article>
                <header><strong>Elementi</strong></header>
                <div id="items-container"></div>
                <button id="add-item-btn" class="outline">Aggiungi Elemento</button>
            </article>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const categoriesContainer = document.getElementById('categories-container');
            const itemsContainer = document.getElementById('items-container');
            const addCategoryBtn = document.getElementById('add-category-btn');
            const addItemBtn = document.getElementById('add-item-btn');
            const saveAllBtn = document.getElementById('save-all-btn');
            const projectName = '{{ project_name }}';

            let gameData = JSON.parse('{{ game_data | tojson | safe }}');
            let nextItemId = 1;

            function initializeState() {
                if (!gameData || typeof gameData !== 'object') gameData = { categories: [], items: [] };
                if (!gameData.categories) gameData.categories = [];
                if (!gameData.items) gameData.items = [];

                let maxId = 0;
                gameData.items.forEach(item => {
                    const idNum = parseInt((item.id || 'item-0').split('-')[1], 10);
                    if (idNum > maxId) maxId = idNum;
                });
                nextItemId = maxId + 1;
            }

            function render() {
                renderCategories();
                renderItems();
            }

            function renderCategories() {
                categoriesContainer.innerHTML = '';
                gameData.categories.forEach((category, index) => {
                    const el = document.createElement('div');
                    el.className = 'list-item';
                    el.dataset.index = index;
                    el.innerHTML = `
                        <input type="text" class="category-name" value="${category.name || ''}" placeholder="Nome categoria">
                        <button class="remove-btn remove-category-btn">X</button>
                    `;
                    categoriesContainer.appendChild(el);
                });
            }

            function renderItems() {
                itemsContainer.innerHTML = '';
                gameData.items.forEach((item, index) => {
                    const el = document.createElement('div');
                    el.className = 'item-row';
                    el.dataset.index = index;

                    const categoryOptions = gameData.categories.map(cat => 
                        `<option value="${cat.id}" ${item.category === cat.id ? 'selected' : ''}>${cat.name}</option>`
                    ).join('');

                    el.innerHTML = `
                        <input type="text" class="item-name" value="${item.name || ''}" placeholder="Nome elemento">
                        <select class="item-category">${categoryOptions}</select>
                        <button class="remove-btn remove-item-btn">X</button>
                    `;
                    itemsContainer.appendChild(el);
                });
            }

            function syncGameDataFromDOM() {
                const categoryElements = categoriesContainer.querySelectorAll('.list-item');
                const newCategories = [];
                categoryElements.forEach(el => {
                    const name = el.querySelector('.category-name').value.trim();
                    if (name) {
                        const id = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
                        newCategories.push({ id, name });
                    }
                });
                gameData.categories = newCategories;

                const itemElements = itemsContainer.querySelectorAll('.item-row');
                const newItems = [];
                itemElements.forEach((el, index) => {
                    const name = el.querySelector('.item-name').value.trim();
                    const category = el.querySelector('.item-category').value;
                    if (name) {
                        const originalId = gameData.items[index]?.id || `item-${nextItemId++}`;
                        newItems.push({ id: originalId, name, category });
                    }
                });
                gameData.items = newItems;
            }

            addCategoryBtn.addEventListener('click', () => {
                syncGameDataFromDOM();
                gameData.categories.push({ id: '', name: 'Nuova Categoria' });
                render();
            });

            addItemBtn.addEventListener('click', () => {
                syncGameDataFromDOM();
                const defaultCategory = gameData.categories.length > 0 ? gameData.categories[0].id : '';
                gameData.items.push({ id: `item-${nextItemId++}`, name: 'Nuovo Elemento', category: defaultCategory });
                render();
            });

            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-category-btn')) {
                    if (confirm('Rimuovendo una categoria, gli elementi associati potrebbero rimanere senza categoria. Continuare?')) {
                        syncGameDataFromDOM();
                        const index = parseInt(e.target.closest('.list-item').dataset.index, 10);
                        gameData.categories.splice(index, 1);
                        render();
                    }
                }
                if (e.target.classList.contains('remove-item-btn')) {
                    syncGameDataFromDOM();
                    const index = parseInt(e.target.closest('.item-row').dataset.index, 10);
                    gameData.items.splice(index, 1);
                    render();
                }
            });

            async function saveAllChanges() {
                syncGameDataFromDOM();
                gameData.categories.forEach(cat => {
                    if (!cat.id) cat.id = cat.name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
                });

                saveAllBtn.disabled = true;
                saveAllBtn.textContent = 'Salvataggio...';
                try {
                    const response = await fetch(`/api/project/${projectName}/visual_data`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(gameData)
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Errore sconosciuto');
                    alert(result.message);
                    initializeState();
                    render();
                } catch (error) {
                    alert(`Errore durante il salvataggio: ${error.message}`);
                } finally {
                    saveAllBtn.disabled = false;
                    saveAllBtn.textContent = 'Salva Tutte le Modifiche';
                }
            }

            saveAllBtn.addEventListener('click', saveAllChanges);

            initializeState();
            render();
        });
    </script>
</body>
</html>