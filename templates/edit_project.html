<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Editor: {{ project_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">
    <!-- Toastify CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
    <div class="editor-container">
        <aside class="file-sidebar">
            <h2>File in {{ project_name }}</h2>
            <ul class="file-list">
                {% for file in files %}
                <li><a href="#" class="file-link" data-filename="{{ file }}">{{ file }}</a></li>
                {% endfor %}
            </ul>
            <a href="{{ url_for('dashboard') }}" class="button secondary">Torna alla Dashboard</a>
        </aside>
        <main class="editor-main">
            <div class="editor-header">
                <h3 id="current-file-name">Seleziona un file per iniziare</h3>
                <div>
                    <a href="{{ url_for('visual_edit_project', project_name=project_name) }}" role="button" class="button">Editor Visuale</a>
                    <button id="save-btn" class="button" disabled>Salva Modifiche</button>
                </div>
            </div>
            <textarea id="code-editor"></textarea>
        </main>
    </div>

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <!-- CodeMirror Modes (for syntax highlighting) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
    <!-- Toastify JS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const editorElement = document.getElementById('code-editor');
            const currentFileNameEl = document.getElementById('current-file-name');
            const saveBtn = document.getElementById('save-btn');
            const fileLinks = document.querySelectorAll('.file-link');
            let currentFile = null;

            // Funzione helper per mostrare le notifiche toast
            function showToast(message, type = 'success') {
                Toastify({
                    text: message,
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: type === 'success' ? "linear-gradient(to right, #00b09b, #96c93d)" : "linear-gradient(to right, #ff5f6d, #ffc371)",
                    stopOnFocus: true,
                }).showToast();
            }

            // 1. Inizializza CodeMirror
            const editor = CodeMirror.fromTextArea(editorElement, {
                lineNumbers: true,
                theme: 'material-darker',
                mode: 'javascript', // ModalitÃ  predefinita
                readOnly: true // Inizia in sola lettura
            });

            // 2. Funzione per caricare il contenuto di un file
            async function loadFile(filename) {
                const response = await fetch(`/api/project/{{ project_name }}/file/${filename}`);
                const data = await response.json();
                
                editor.setValue(data.content);
                const extension = filename.split('.').pop();
                if (extension === 'html') editor.setOption('mode', 'xml');
                else if (extension === 'css') editor.setOption('mode', 'css');
                else if (extension === 'js') editor.setOption('mode', 'javascript');
                else editor.setOption('mode', 'null');

                currentFile = filename;
                currentFileNameEl.textContent = `Modifica: ${filename}`;
                saveBtn.disabled = false;
                editor.setOption('readOnly', false);
                
                fileLinks.forEach(link => link.classList.toggle('active', link.dataset.filename === filename));
            }

            // 3. Funzione per salvare il contenuto del file
            async function saveFile() {
                if (!currentFile) return;
                saveBtn.disabled = true;
                saveBtn.textContent = 'Salvataggio...';
                try {
                    const response = await fetch(`/api/project/{{ project_name }}/file/${currentFile}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: editor.getValue() })
                    });
                    const result = await response.json();
                    showToast(result.message || result.error, response.ok ? 'success' : 'error');
                } catch (error) {
                    showToast('Errore di connessione con il server.', 'error');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Salva Modifiche';
                }
            }

            // 4. Aggiungi gli event listener
            fileLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadFile(e.target.dataset.filename);
                });
            });

            saveBtn.addEventListener('click', saveFile);
        });
    </script>
</body>
</html>